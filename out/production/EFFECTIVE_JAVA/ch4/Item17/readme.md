# 변경 가능성을 최소화하라
`불변 클래스`는 해당 객체의 내부의 정보를 수정할 수 없는 클래스를 뜻합니다. 현재 자바에서도 여러 불변 클래스들을 사용하고 있습니다.  
(ex: `String`, 래퍼 클래스, `BigInteger`, ...)

## 불변 클래스 장점
단순히 생각하면, 변경가능성이 많아야 다루기 쉽지 않을까? 라는 생각을 어렴풋이 해보지만 절대 그렇지 않습니다. 
왜 불변클래스를 만들어야 하는지에 대해 알아봅시다.

### 단순하다
* 생명주기 내 상태가 변경되지 않고 그대로 간직한다.

### 스레드에 안전하다 (중요!)
* 여러 스레드가 동시에 사용해도 변경되지 않기 때문에 동기화할 필요가 없어진다.
* 안심하고 공유할 수 있다.
* 그렇기 때문에 왠만하면 최대한 재활용 하는 방향을 잡아야 한다.

### 불변 객체끼리 내부 데이터를 공유 할 수 있다.
불변성을 보증하기 때문에 얼마든지 데이터를 공유해도 상관 없습니다! 가장 대표적인 예시가 `BigInteger`의 `negate()` 메서드를 통한 int 배열 공유 입니다.

### 객체를 만들 때 다른 불변 객체들을 구성요소로 사용하면 이점이 많다.
* 아무리 구조가 복잡해지더라도, 불변식을 유지하기가 쉬워진다.
* 가령 Map.key, Set.element 들은 불변 객체를 사용하면 안성맞춤이다.

### 실패 원자성 제공
예외가 발생한 후에도 객가 여전히 호출전과 동일한 상태를 유지합니다. 덕분에 객체 불일치를 걱정할 필요가 없습니다!

## 단점
### 값이 다르면 반드시 독립된 객체로 만들어야 한다.
불변 클래스의 Trade-Off를 고민하게 되는 가장 큰 단점입니다. 정말 이 객체가 무슨일이 있어도 바뀔일이 없다면 사용하면 되는데 만약 운영 도중 변경 가능성이 있으면 
큰 비용 소모를 감수해야 합니다.
* 예시
  * 필드 100개를 가지는 객체 중 단 하나의 필드만 변경해야 할 때 => 불변성이라서 변경 불가 => 그렇다고 새로 만들자니 비용 소모가 크다.

이렇게 **그 객체가 정말 불변성을 가져야 하는가?** 에 대한 고민을 많이 하시고 설계를 해야 합니다.


## 불변 클래스 생성 방법
### 1. 객체의 상태를 변경하는 메서드를 제공하지 않는다.
불변성을 보장하기 위해서는 당연히 상태 변경을 막아야 합니다.

### 2. 클래스를 확장할 수 없도록 한다.
물론 확장을 열어두고 명세에 불변성을 명시하는 방법도 있으나, 이 방법은 완벽하게 불변성을 통제하지는 못합니다. 그렇기 때문에 애초에 확장을 막아버리는 것이 좋습니다.
이를 통해 하위 클래스에서 부주의하게 객체의 상태를 변하게 만드는 사태를 예방할 수 있습니다.
이 목표를 달성할 수 있는 가장 단순한 방법은 클래스를 `final`로 선언하는 것입니다!  
(예시: `public final class String{...}`)  
추가적으로 Item1, 4에서 배운 **모든 생성자를 private, package-private로 선언하고 public 정적 팩토리를 제공**하는 것도 좋은 방법입니다.

### 3. 모든 필드를 final로 선언한다.
필드에 `final`을 못박아버리는 것이 사용자들에게 설계자의 의도를 가장 명확하게 드러내는 방법 중 하나가 될 수 있습니다.
추가적으로 **인스턴스를 동기화 없이 다른 스레드로 건네도 문제없이 동작하게끔 보장하는 데도 필요**합니다.
하지만, 사실 이 규칙은 너무 지키기가 힘듭니다. 이 방법을 절대적으로 지키는 것 보다는 풀어주고 다른 곳에서 불변성을 얻는 것을 보통 추천합니다.

### 4. 모든 필드를 private으로 선언한다.
앞 Item에서 배웠듯이 클라이언트가 직접 접근해 필드를 수정하는 것을 막아주는 방법입니다. 보통 기본 타입 필드나, 불변 객체를 참조하는 필드를 
`public final`로만 선언해도 불변 객체가 되나, 다음 release에서 내부 표현을 바꾸지 못하므로 권장하는 방법은 아닙니다. 이전장에서도 그렇게 추천하는
방법은 아니라고 설명했었습니다!

### 5. 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.
클래스에 가변 객체를 참조하는 필드가 하나라도 있다면, 클라이언트가 참조를 얻을 수 없도록 막는 방법입니다. 절대로 클라이언트가 제공한 객체 참조를
가리키게 해서도 안되며, 접근자 메서드가 이 필드를 그대로 반환해서도 안됩니다!! 만약 제공을 해주려면 **방어적 복사**를 통해 해당 필드를 제공을 해주어야 합니다.  
(`Complex.class` 참고)
  


## 결론
* 무조건 Getter, Setter을 만들지 마라
* 클래스는 꼭 필요한 경우가 아니면 불변이어야 한다.
* 불변으로 만들 수 없는 클래스는 변경할 수 있는 부분을 최소한으로 줄이자.
  * 다른 합당한 이유가 없다면 모든 필드는 private final 이어야 한다.
* 생성자는 불변식 설정이 모두 완료된 (=초기화가 끝난) 상태의 객체를 생성해야 한다.
